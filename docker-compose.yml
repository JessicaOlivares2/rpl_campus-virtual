version: '3.8'

services:
  # -----------------------------------------------
  # 1. CAMPUS VIRTUAL RPL (Tu proyecto - Jessi)
  # -----------------------------------------------
  campus-rpl:
    build: ./campus-virtual
    container_name: campus_rpl_lms
    ports:
      - "8080:3000" 
    environment:
      - NODE_ENV=production
      # âœ… CORREGIDO: Apuntamos al nuevo servicio 'prisma-db'
      - DATABASE_URL="mysql://prismauser:prismapassword@prisma-db:3306/campus_rpl_db" 
    # Depende de la nueva DB de Prisma
    depends_on: [prisma-db, moodle-app] 
    volumes:
      - campus_data:/app/prisma 
    restart: always

  # -----------------------------------------------
  # 2. BASE DE DATOS DEDICADA PARA PRISMA/NEXT.JS
  # -----------------------------------------------
  prisma-db:
    image: mysql:8.0
    container_name: prisma_mysql_db
    ports:
      - "3306:3306"
    restart: always
    environment:
      # ðŸš¨ Credenciales que debe usar el DATABASE_URL de Next.js
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: campus_rpl_db # Nombre de la DB para tu app
      MYSQL_USER: prismauser
      MYSQL_PASSWORD: prismapassword
    # No es necesario exponer el puerto 3306 al host, solo a la red Docker
    volumes:
      - prisma_db_data:/var/lib/mysql

  # -----------------------------------------------
  # 3. MOODLE (LMS Requerido - Sin Cambios)
  # -----------------------------------------------
  moodle-db:
    image: mysql:8.0
    container_name: moodle_mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: moodlerootpassword
      MYSQL_DATABASE: moodle
      MYSQL_USER: moodleuser
      MYSQL_PASSWORD: moodlepassword
    volumes:
      - moodle_db_data:/var/lib/mysql

  moodle-app:
    image: bitnami/moodle:latest 
    container_name: moodle_app_lms
    restart: always
    ports:
      - "8081:8080" 
    depends_on: [moodle-db]
    environment:
      MOODLE_DATABASE_HOST: moodle-db
      MOODLE_DATABASE_USER: moodleuser
      MOODLE_DATABASE_PASSWORD: moodlepassword
      MOODLE_DATABASE_NAME: moodle
      MOODLE_HOST: http://10.56.2.16:8081 
    volumes:
      - moodle_data:/bitnami/moodle
      
# DefiniciÃ³n de VolÃºmenes (AÃ±adimos uno nuevo para Prisma)
volumes:
  campus_data:
  moodle_db_data:
  moodle_data:
  prisma_db_data: # âœ… Nuevo volumen para la DB de Prisma