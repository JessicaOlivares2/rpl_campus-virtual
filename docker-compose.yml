version: '3.8'

services:
  # -----------------------------------------------
  # 1. CAMPUS VIRTUAL RPL (Tu proyecto - Jessi)
  # -----------------------------------------------
  campus-rpl:
    build: ./campus-virtual
    container_name: campus_rpl_lms
    ports:
      - "8080:3000" 
    environment:
      - NODE_ENV=production
      # ‚úÖ CORREGIDO: Apuntamos al nuevo servicio 'prisma-db'
      - DATABASE_URL="mysql://prismauser:prismapassword@prisma-db:3306/campus_rpl_db" 
    # Depende de la nueva DB de Prisma
    depends_on: [prisma-db, moodle-app] 
    volumes:
      - campus_data:/app/prisma 
    restart: always

  # -----------------------------------------------
  # 2. BASE DE DATOS DEDICADA PARA PRISMA/NEXT.JS
  # -----------------------------------------------
  prisma-db:
    image: mysql:8.0
    container_name: prisma_mysql_db
    ports:
      - "3306:3306"
    restart: always
    environment:
      # üö® Credenciales que debe usar el DATABASE_URL de Next.js
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: campus_rpl_db # Nombre de la DB para tu app
      MYSQL_USER: prismauser
      MYSQL_PASSWORD: prismapassword
    # No es necesario exponer el puerto 3306 al host, solo a la red Docker
    volumes:
      - prisma_db_data:/var/lib/mysql

  # -----------------------------------------------
  # 3. MOODLE (LMS Requerido - Sin Cambios)
  # -----------------------------------------------
# -----------------------------------------------
  # 2. BASE DE DATOS DEDICADA PARA PRISMA/NEXT.JS (con MariaDB)
  # -----------------------------------------------
  prisma-db:
    image: mariadb:10.6 # ‚¨ÖÔ∏è CAMBIADO A MARIADB
    container_name: prisma_mysql_db
    ports:
      - "3306:3306"
    restart: always
    environment:
      # Las credenciales y DB deben coincidir con tu .env
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: campus_rpl_db 
      MYSQL_USER: prismauser
      MYSQL_PASSWORD: prismapassword
    volumes:
      - prisma_db_data:/var/lib/mysql